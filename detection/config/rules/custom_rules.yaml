# ==============================================
# SIB Custom Falco Rules
# ==============================================
# Add your custom security rules here.
# These rules are loaded after the default rules.
# ==============================================

# ---------------------------------------------
# Critical Test Rule (for verification)
# ---------------------------------------------

- rule: Critical Test - Shadow File Read
  desc: Triggers Critical alert when /etc/shadow is read
  condition: >
    open_read and 
    fd.name = "/etc/shadow"
  output: >
    CRITICAL: Shadow file accessed 
    (user=%user.name user_uid=%user.uid command=%proc.cmdline 
     parent=%proc.pname container_id=%container.id 
     container_name=%container.name image=%container.image.repository)
  priority: CRITICAL
  tags: [test, critical, shadow]

# ---------------------------------------------
# Cryptocurrency Mining Detection
# ---------------------------------------------

- rule: Detect Cryptocurrency Mining Process
  desc: Detects known cryptocurrency mining processes
  condition: >
    spawned_process and 
    (proc.name in (xmrig, minerd, cpuminer, ethminer, cgminer, bfgminer, 
                   nbminer, t-rex, phoenixminer, lolminer, gminer) or
     proc.cmdline contains "stratum+tcp" or
     proc.cmdline contains "pool.minexmr" or
     proc.cmdline contains "nanopool" or
     proc.cmdline contains "nicehash")
  output: >
    Cryptocurrency miner detected 
    (user=%user.name user_uid=%user.uid command=%proc.cmdline 
     parent=%proc.pname container_id=%container.id 
     container_name=%container.name image=%container.image.repository)
  priority: CRITICAL
  tags: [cryptomining, mitre_impact, T1496]

- rule: Detect Cryptocurrency Mining Network Connection
  desc: Detects network connections to known mining pool ports
  condition: >
    outbound and 
    fd.sport in (3333, 4444, 8888, 14444, 45700)
  output: >
    Possible mining pool connection 
    (user=%user.name command=%proc.cmdline connection=%fd.name 
     container_id=%container.id container_name=%container.name)
  priority: WARNING
  tags: [cryptomining, network, mitre_impact]

# ---------------------------------------------
# Container Security
# ---------------------------------------------

- rule: Container Escape via Mount
  desc: Detects potential container escape via mount manipulation
  condition: >
    spawned_process and 
    container and
    proc.name = mount and
    (proc.cmdline contains "/host" or 
     proc.cmdline contains "nsenter" or
     proc.cmdline contains "/proc/1")
  output: >
    Potential container escape via mount 
    (user=%user.name command=%proc.cmdline container_id=%container.id 
     container_name=%container.name image=%container.image.repository)
  priority: CRITICAL
  tags: [container, escape, mitre_privilege_escalation, T1611]

- rule: Container Running as Root
  desc: Detects containers running processes as root
  condition: >
    spawned_process and 
    container and 
    user.uid = 0 and
    not proc.name in (init, systemd, containerd, dockerd, runc)
  output: >
    Container process running as root 
    (user=%user.name command=%proc.cmdline container_id=%container.id 
     container_name=%container.name image=%container.image.repository)
  priority: NOTICE
  tags: [container, root, mitre_privilege_escalation]

# ---------------------------------------------
# Suspicious Network Activity
# ---------------------------------------------

- rule: Outbound Connection to Suspicious Port
  desc: Detects outbound connections to commonly abused ports
  condition: >
    outbound and 
    (fd.sport in (4444, 5555, 6666, 7777, 8888, 9999, 1337, 31337) or
     fd.sport > 60000)
  output: >
    Suspicious outbound connection 
    (user=%user.name command=%proc.cmdline connection=%fd.name 
     container_id=%container.id container_name=%container.name)
  priority: WARNING
  tags: [network, suspicious, mitre_command_and_control]

# Note: DNS query detection for suspicious domains requires network monitoring 
# tools or Falco plugins. Port-based detection is limited.

# ---------------------------------------------
# Credential Access
# ---------------------------------------------

- rule: Read AWS Credentials File
  desc: Detects reading of AWS credentials file
  condition: >
    open_read and 
    (fd.name = "/root/.aws/credentials" or
     fd.name contains "/.aws/credentials")
  output: >
    AWS credentials file accessed 
    (user=%user.name command=%proc.cmdline file=%fd.name 
     container_id=%container.id container_name=%container.name)
  priority: WARNING
  tags: [credential_access, aws, mitre_credential_access, T1552]

- rule: Read Kubernetes Secrets
  desc: Detects access to Kubernetes secrets directory
  condition: >
    open_read and 
    fd.name startswith "/var/run/secrets/kubernetes.io"
  output: >
    Kubernetes secrets accessed 
    (user=%user.name command=%proc.cmdline file=%fd.name 
     container_id=%container.id container_name=%container.name)
  priority: NOTICE
  tags: [credential_access, kubernetes, mitre_credential_access]

- rule: Read SSH Private Key
  desc: Detects reading of SSH private keys
  condition: >
    open_read and 
    (fd.name contains "id_rsa" or
     fd.name contains "id_ed25519" or
     fd.name contains "id_ecdsa" or
     fd.name contains "id_dsa") and
    not fd.name contains ".pub"
  output: >
    SSH private key accessed 
    (user=%user.name command=%proc.cmdline file=%fd.name 
     container_id=%container.id)
  priority: WARNING
  tags: [credential_access, ssh, mitre_credential_access, T1552.004]

# ---------------------------------------------
# Persistence
# ---------------------------------------------

- rule: Crontab Modified
  desc: Detects modifications to crontab files
  condition: >
    (open_write or evt.type = rename) and
    (fd.name startswith "/etc/cron" or
     fd.name startswith "/var/spool/cron")
  output: >
    Crontab modified 
    (user=%user.name command=%proc.cmdline file=%fd.name 
     container_id=%container.id)
  priority: WARNING
  tags: [persistence, cron, mitre_persistence, T1053.003]

- rule: Systemd Service Created
  desc: Detects creation of new systemd services
  condition: >
    open_write and
    (fd.name startswith "/etc/systemd/system" or
     fd.name startswith "/lib/systemd/system") and
    fd.name endswith ".service"
  output: >
    Systemd service created 
    (user=%user.name command=%proc.cmdline file=%fd.name 
     container_id=%container.id)
  priority: WARNING
  tags: [persistence, systemd, mitre_persistence, T1543.002]

# ---------------------------------------------
# Suspicious Commands
# ---------------------------------------------

- rule: Base64 Decode Execution
  desc: Detects base64 decode being piped to shell (common attack pattern)
  condition: >
    spawned_process and
    (proc.cmdline contains "base64 -d" or
     proc.cmdline contains "base64 --decode") and
    (proc.cmdline contains "| sh" or
     proc.cmdline contains "| bash" or
     proc.cmdline contains "|sh" or
     proc.cmdline contains "|bash")
  output: >
    Base64 decode piped to shell 
    (user=%user.name command=%proc.cmdline parent=%proc.pname 
     container_id=%container.id)
  priority: WARNING
  tags: [execution, base64, mitre_execution, T1059]

- rule: Wget or Curl to Suspicious Location
  desc: Detects downloading files to tmp or suspicious locations
  condition: >
    spawned_process and
    proc.name in (wget, curl) and
    (proc.cmdline contains "/tmp/" or
     proc.cmdline contains "/dev/shm/" or
     proc.cmdline contains "/var/tmp/")
  output: >
    Download to suspicious location 
    (user=%user.name command=%proc.cmdline container_id=%container.id 
     container_name=%container.name)
  priority: WARNING
  tags: [execution, download, mitre_execution]

# ---------------------------------------------
# Initial Access Detection (T1190, T1133)
# ---------------------------------------------

- rule: Reverse Shell Spawned
  desc: Detects reverse shell patterns commonly used in initial access
  condition: >
    spawned_process and
    ((proc.cmdline contains "/dev/tcp/" or
      proc.cmdline contains "nc -e" or
      proc.cmdline contains "ncat -e" or
      proc.cmdline contains "bash -i" or
      proc.cmdline contains "python -c" and proc.cmdline contains "socket") or
     (proc.name in (nc, ncat, netcat) and 
      (proc.cmdline contains "-e" or proc.cmdline contains "-c")))
  output: >
    Reverse shell detected 
    (user=%user.name command=%proc.cmdline parent=%proc.pname 
     container_id=%container.id container_name=%container.name)
  priority: CRITICAL
  tags: [initial_access, reverse_shell, mitre_initial_access, T1059]

- rule: Remote Script Execution
  desc: Detects curl/wget piped directly to shell (drive-by download)
  condition: >
    spawned_process and
    (proc.cmdline contains "curl" or proc.cmdline contains "wget") and
    (proc.cmdline contains "| sh" or proc.cmdline contains "| bash" or
     proc.cmdline contains "|sh" or proc.cmdline contains "|bash")
  output: >
    Remote script execution detected 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: CRITICAL
  tags: [initial_access, remote_execution, mitre_initial_access, T1190]

# ---------------------------------------------
# Discovery Detection (T1082, T1083, T1057)
# ---------------------------------------------

- rule: System Information Discovery
  desc: Detects reconnaissance commands for system enumeration
  condition: >
    spawned_process and
    proc.name in (uname, hostnamectl, lsb_release, cat) and
    (proc.cmdline contains "os-release" or
     proc.cmdline contains "/etc/issue" or
     proc.cmdline contains "-a" and proc.name = "uname")
  output: >
    System information discovery 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: NOTICE
  tags: [discovery, reconnaissance, mitre_discovery, T1082]

- rule: Network Configuration Discovery
  desc: Detects network enumeration commands
  condition: >
    spawned_process and
    proc.name in (ifconfig, ip, netstat, ss, arp, route)
  output: >
    Network discovery 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: NOTICE
  tags: [discovery, network, mitre_discovery, T1016]

- rule: Process Discovery
  desc: Detects process enumeration
  condition: >
    spawned_process and
    proc.name in (ps, top, htop, pstree) and
    (proc.cmdline contains "aux" or proc.cmdline contains "-ef" or
     proc.cmdline contains "-e")
  output: >
    Process discovery 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: NOTICE
  tags: [discovery, processes, mitre_discovery, T1057]

- rule: Account Discovery
  desc: Detects user enumeration commands
  condition: >
    spawned_process and
    (proc.name in (whoami, id, who, w, last, lastlog, users) or
     (proc.name = "cat" and proc.cmdline contains "/etc/passwd") or
     (proc.name = "getent" and proc.cmdline contains "passwd"))
  output: >
    Account discovery 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: NOTICE
  tags: [discovery, accounts, mitre_discovery, T1087]

# ---------------------------------------------
# Lateral Movement Detection (T1021)
# ---------------------------------------------

- rule: SSH to Internal Host
  desc: Detects SSH connections from containers
  condition: >
    spawned_process and
    proc.name in (ssh, scp, sftp) and
    container
  output: >
    SSH from container detected 
    (user=%user.name command=%proc.cmdline container_id=%container.id 
     container_name=%container.name)
  priority: WARNING
  tags: [lateral_movement, ssh, mitre_lateral_movement, T1021.004]

- rule: Remote File Copy
  desc: Detects tools used for lateral movement file transfer
  condition: >
    spawned_process and
    proc.name in (scp, rsync, rcp) and
    container
  output: >
    Remote file copy detected 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: WARNING
  tags: [lateral_movement, file_transfer, mitre_lateral_movement, T1021]

- rule: Network Scan Detected
  desc: Detects network scanning tools often used before lateral movement
  condition: >
    spawned_process and
    proc.name in (nmap, masscan, zmap, nc, netcat, ncat)
  output: >
    Network scanning detected 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: WARNING
  tags: [lateral_movement, scanning, mitre_lateral_movement, T1046]

# ---------------------------------------------
# Exfiltration Detection (T1048, T1041)
# ---------------------------------------------

- rule: Data Exfiltration via Curl
  desc: Detects data being posted externally via curl
  condition: >
    spawned_process and
    proc.name = "curl" and
    (proc.cmdline contains "-X POST" or proc.cmdline contains "--data" or
     proc.cmdline contains "-d " or proc.cmdline contains "-F ")
  output: >
    Potential data exfiltration via curl 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: WARNING
  tags: [exfiltration, curl, mitre_exfiltration, T1048]

- rule: Archive Creation Before Exfil
  desc: Detects archive creation which often precedes exfiltration
  condition: >
    spawned_process and
    proc.name in (tar, zip, gzip, 7z, rar) and
    (proc.cmdline contains "/etc" or
     proc.cmdline contains "/home" or
     proc.cmdline contains "/root" or
     proc.cmdline contains "passwd" or
     proc.cmdline contains ".ssh")
  output: >
    Sensitive data archiving detected 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: WARNING
  tags: [exfiltration, archive, mitre_exfiltration, T1560]

- rule: DNS Exfiltration Attempt
  desc: Detects potential DNS tunneling/exfiltration
  condition: >
    spawned_process and
    proc.name in (dig, nslookup, host) and
    (proc.cmdline contains "TXT" or proc.cmdline contains "txt")
  output: >
    Potential DNS exfiltration 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: WARNING
  tags: [exfiltration, dns, mitre_exfiltration, T1048.003]

# ---------------------------------------------
# Impact Detection (T1485, T1486, T1489)
# ---------------------------------------------

- rule: File Deletion in Bulk
  desc: Detects mass file deletion (potential ransomware or destruction)
  condition: >
    spawned_process and
    proc.name = "rm" and
    (proc.cmdline contains "-rf" or proc.cmdline contains "-r") and
    (proc.cmdline contains "/home" or
     proc.cmdline contains "/var" or
     proc.cmdline contains "/etc" or
     proc.cmdline contains "/*")
  output: >
    Mass file deletion detected 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: CRITICAL
  tags: [impact, destruction, mitre_impact, T1485]

- rule: Service Stop Command
  desc: Detects stopping of critical services
  condition: >
    spawned_process and
    (proc.name = "systemctl" or proc.name = "service") and
    (proc.cmdline contains "stop" or proc.cmdline contains "disable")
  output: >
    Service stopped 
    (user=%user.name command=%proc.cmdline container_id=%container.id)
  priority: WARNING
  tags: [impact, service_stop, mitre_impact, T1489]

- rule: Disk Wipe Attempt
  desc: Detects attempts to wipe disk or overwrite files
  condition: >
    spawned_process and
    (proc.name = "dd" and 
     (proc.cmdline contains "if=/dev/zero" or proc.cmdline contains "if=/dev/urandom") and
     (proc.cmdline contains "/dev/sd" or proc.cmdline contains "/dev/nvme"))
  output: >
    Disk wipe attempt detected 
    (user=%user.name command=%proc.cmdline)
  priority: CRITICAL
  tags: [impact, disk_wipe, mitre_impact, T1561]
