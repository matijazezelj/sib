# Health Check for SIB Fleet
# Verifies all agents are running and communicating with central
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/health-check.yml
---

- name: SIB Fleet Health Check
  hosts: fleet
  become: true
  gather_facts: true
  
  pre_tasks:
    - name: Check if Docker is available
      ansible.builtin.command: docker info
      register: docker_check
      changed_when: false
      failed_when: false
      tags: always

    - name: Set Docker availability
      ansible.builtin.set_fact:
        docker_available: "{{ docker_check.rc == 0 }}"
      tags: always

  tasks:
    # =========================================================================
    # Docker-based checks
    # =========================================================================
    - name: Check Falco container status
      ansible.builtin.command: docker ps --filter name=falco --format "{{ '{{.Status}}' }}"
      register: falco_docker_status
      changed_when: false
      failed_when: false
      when: docker_available | bool
      tags: falco

    - name: Check Alloy container status
      ansible.builtin.command: docker ps --filter name=sib-alloy --format "{{ '{{.Status}}' }}"
      register: alloy_docker_status
      changed_when: false
      failed_when: false
      when: docker_available | bool and sib_stack | default('vm') == 'grafana'
      tags: alloy

    - name: Check VM collectors container status
      ansible.builtin.command: >-
        docker ps --filter name=sib-vmagent --filter name=sib-node-exporter --format "{{ '{{.Names}}: {{.Status}}' }}"
      register: vm_collectors_docker_status
      changed_when: false
      failed_when: false
      when: docker_available | bool and sib_stack | default('vm') == 'vm'
      tags: vm_collectors

    # =========================================================================
    # Native service checks
    # =========================================================================
    - name: Check Falco native service status
      ansible.builtin.command: systemctl is-active falco
      register: falco_native_status
      changed_when: false
      failed_when: false
      tags: falco

    - name: Check Alloy native service status
      ansible.builtin.command: systemctl is-active alloy
      register: alloy_native_status
      changed_when: false
      failed_when: false
      tags: alloy

    # =========================================================================
    # Connectivity checks
    # =========================================================================
    - name: Test connectivity to SIB Loki (Grafana stack)
      ansible.builtin.uri:
        url: "{{ sib_loki_url }}/ready"
        method: GET
        status_code: 200
        timeout: 5
      register: loki_health
      failed_when: false
      when: sib_stack | default('vm') == 'grafana'
      tags: connectivity

    - name: Test connectivity to SIB VictoriaMetrics (VM stack)
      ansible.builtin.uri:
        url: "{{ sib_victoriametrics_url }}/health"
        method: GET
        status_code: 200
        timeout: 5
      register: vm_health
      failed_when: false
      when: sib_stack | default('vm') == 'vm'
      tags: connectivity

    - name: Test connectivity to SIB Falcosidekick
      ansible.builtin.uri:
        url: "http://{{ sib_server }}:2801/healthz"
        method: GET
        status_code: 200
        timeout: 5
      register: sidekick_health
      failed_when: false
      tags: connectivity

    # =========================================================================
    # Aggregate health status
    # =========================================================================
    - name: Set health status facts
      ansible.builtin.set_fact:
        falco_healthy: >-
          {{ (falco_docker_status.stdout | default('')) is search('Up') or
             (falco_native_status.stdout | default('')) == 'active' }}
        alloy_healthy: >-
          {{ (alloy_docker_status.stdout | default('')) is search('Up') or
             (alloy_native_status.stdout | default('')) == 'active' }}
        vm_collectors_healthy: >-
          {{ (vm_collectors_docker_status.stdout | default('')) is search('Up') }}
        loki_reachable: "{{ loki_health.status | default(0) == 200 }}"
        vm_reachable: "{{ vm_health.status | default(0) == 200 }}"
        sidekick_reachable: "{{ sidekick_health.status | default(0) == 200 }}"
        falco_deployment_type: >-
          {{ 'docker' if (falco_docker_status.stdout | default('')) is search('Up') else
             'native' if (falco_native_status.stdout | default('')) == 'active' else 'none' }}
        alloy_deployment_type: >-
          {{ 'docker' if (alloy_docker_status.stdout | default('')) is search('Up') else
             'native' if (alloy_native_status.stdout | default('')) == 'active' else 'none' }}
      tags: always

    - name: Display health status
      ansible.builtin.debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ¥ Health Check: {{ inventory_hostname }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Local Services:
            Falco:     {{ 'âœ… Running' if falco_healthy else 'âŒ NOT RUNNING' }} ({{ falco_deployment_type | trim }})
            {% if sib_stack | default('vm') == 'grafana' %}
            Alloy:     {{ 'âœ… Running' if alloy_healthy else 'âŒ NOT RUNNING' }} ({{ alloy_deployment_type | trim }})
            {% else %}
            VM Collectors: {{ 'âœ… Running' if vm_collectors_healthy else 'âŒ NOT RUNNING' }} (docker)
            {% endif %}
            Docker:    {{ 'âœ… Available' if docker_available else 'âš ï¸  Not installed' }}
          
          Central Connectivity:
            {% if sib_stack | default('vm') == 'grafana' %}
            Loki:      {{ 'âœ… Reachable' if loki_reachable else 'âŒ UNREACHABLE' }}
            {% else %}
            VictoriaMetrics: {{ 'âœ… Reachable' if vm_reachable else 'âŒ UNREACHABLE' }}
            {% endif %}
            Sidekick:  {{ 'âœ… Reachable' if sidekick_reachable else 'âŒ UNREACHABLE' }}
          
          Host Info:
            OS:        {{ ansible_distribution }} {{ ansible_distribution_version }}
            Kernel:    {{ ansible_kernel }}
            Uptime:    {{ ansible_uptime_seconds | int // 86400 }} days
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tags: always

    - name: Fail if critical services are down
      ansible.builtin.fail:
        msg: "Critical services not healthy on {{ inventory_hostname }}"
      when: >-
        not falco_healthy or
        (sib_stack | default('vm') == 'grafana' and not alloy_healthy) or
        (sib_stack | default('vm') == 'vm' and not vm_collectors_healthy)
      tags: verify


- name: Fleet Summary
  hosts: localhost
  gather_facts: false
  
  tasks:
    - name: Generate fleet summary
      ansible.builtin.debug:
        msg: |
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“Š SIB Fleet Health Summary
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Total Hosts Checked: {{ groups['fleet'] | length }}
          
          View detailed status in Grafana:
          http://{{ hostvars[groups['fleet'][0]]['sib_server'] }}:3000
          
          Dashboard: Fleet Overview
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
