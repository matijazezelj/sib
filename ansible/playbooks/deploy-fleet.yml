# Deploy SIB Fleet Agents
# Installs Falco and collectors (Alloy or vmagent) on all fleet hosts
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy-fleet.yml
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy-fleet.yml --limit webserver
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy-fleet.yml --tags falco
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy-fleet.yml -e mtls_enabled=true
---

- name: Deploy SIB Fleet Agents
  hosts: fleet
  become: true

  vars:
    deployment_timestamp: "{{ ansible_date_time.iso8601 }}"

  pre_tasks:
    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          Deploying SIB agents to {{ inventory_hostname }}
          SIB Server: {{ sib_server }}
          Stack: {{ sib_stack | default('vm') }}
          Falco Version: {{ falco_version }}
          Deployment Strategy: {{ deployment_strategy }}
          mTLS Enabled: {{ mtls_enabled | default(false) }}
      tags: always

    - name: Gather facts
      ansible.builtin.setup:
        gather_subset:
          - hardware
          - network
          - distribution
      tags: always

    - name: Validate mTLS prerequisites
      when: mtls_enabled | default(false) | bool
      tags: [always, certs]
      block:
        - name: Check if client certificate exists for this host
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../certs/clients/{{ inventory_hostname }}.crt"
          delegate_to: localhost
          register: client_cert_check

        - name: Fail if mTLS enabled but certificate missing
          ansible.builtin.fail:
            msg: |
              mTLS is enabled but certificate not found for '{{ inventory_hostname }}'
              Run: make generate-client-cert HOST={{ inventory_hostname }}
          when: not client_cert_check.stat.exists

  roles:
    - role: common
      tags: [common, setup]

    # Distribute certificates when mTLS is enabled
    - role: certs
      tags: [certs, security]
      when: mtls_enabled | default(false) | bool

    - role: falco
      tags: [falco, detection]

    # Grafana stack: use Alloy for logs/metrics
    - role: alloy
      tags: [alloy, shipping]
      when: sib_stack | default('vm') == 'grafana'

    # VM stack: use vmagent + node_exporter for metrics
    - role: vm_collectors
      tags: [vm_collectors, shipping]
      when: sib_stack | default('vm') == 'vm'

  post_tasks:
    - name: Verify Falco is running
      ansible.builtin.command: "{{ 'docker ps --filter name=sib-falco --format \"{{.Status}}\"' if effective_deployment | trim == 'docker' else 'systemctl is-active falco' }}"
      register: falco_status
      changed_when: false
      failed_when: false
      when: not (is_lxc | default(false))
      tags: verify

    - name: Set Falco status for LXC
      ansible.builtin.set_fact:
        falco_status:
          stdout: "skipped (LXC not supported)"
      when: is_lxc | default(false)
      tags: verify

    - name: Verify Alloy is running
      ansible.builtin.command: docker ps --filter name=sib-alloy --format "{{ '{{.Status}}' }}"
      register: alloy_status
      changed_when: false
      failed_when: false
      when: sib_stack | default('vm') == 'grafana'
      tags: verify

    - name: Verify VM collectors are running
      ansible.builtin.command: >-
        docker ps --filter name=sib-vmagent --filter name=sib-node-exporter --format "{{ '{{.Names}}: {{.Status}}' }}"
      register: vm_collectors_status
      changed_when: false
      failed_when: false
      when: sib_stack | default('vm') == 'vm'
      tags: verify

    - name: Deployment summary
      ansible.builtin.debug:
        msg: |
          âœ… Deployment complete for {{ inventory_hostname }}

          Falco: {{ falco_status.stdout | default('not running') }}
          {% if sib_stack | default('vm') == 'grafana' %}
          Alloy: {{ alloy_status.stdout | default('not running') }}
          Logs shipping to: {{ sib_loki_url }}
          Metrics shipping to: {{ sib_prometheus_url }}
          {% else %}
          VM Collectors: {{ vm_collectors_status.stdout | default('not running') }}
          Metrics shipping to: {{ sib_victoriametrics_url }}
          {% endif %}
          mTLS: {{ 'enabled' if mtls_enabled | default(false) | bool else 'disabled' }}
          Events shipping to: {{ falco_outputs.http_url }}
      tags: verify
