# Remove SIB Fleet Agents
# Uninstalls Falco and Alloy from fleet hosts
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/remove-fleet.yml
#   ansible-playbook -i inventory/hosts.yml playbooks/remove-fleet.yml --limit webserver
---

- name: Remove SIB Fleet Agents
  hosts: fleet
  become: true
  
  vars:
    confirm_removal: false  # Set to true or use -e confirm_removal=true
  
  pre_tasks:
    - name: Confirm removal
      ansible.builtin.fail:
        msg: |
          ⚠️  This will remove all SIB agents from {{ inventory_hostname }}
          
          To confirm, run with: -e confirm_removal=true
      when: not confirm_removal
      tags: always

    - name: Check if Docker is available
      ansible.builtin.command: docker info
      register: docker_check
      changed_when: false
      failed_when: false
      tags: always

    - name: Set Docker availability
      ansible.builtin.set_fact:
        docker_available: "{{ docker_check.rc == 0 }}"
      tags: always

  tasks:
    # =========================================================================
    # Remove Docker-based deployments
    # =========================================================================
    - name: Stop and remove Falco container
      community.docker.docker_container:
        name: falco
        state: absent
      when: docker_available | bool
      ignore_errors: true
      tags: falco

    - name: Stop and remove Alloy container
      community.docker.docker_container:
        name: sib-alloy
        state: absent
      when: docker_available | bool
      ignore_errors: true
      tags: alloy

    - name: Stop and remove VM collectors containers
      community.docker.docker_container:
        name: "{{ item }}"
        state: absent
      loop:
        - sib-vmagent
        - sib-node-exporter
      when: docker_available | bool
      ignore_errors: true
      tags: vm_collectors

    # =========================================================================
    # Remove native Falco installation
    # =========================================================================
    - name: Stop Falco service
      ansible.builtin.service:
        name: falco
        state: stopped
        enabled: false
      ignore_errors: true
      tags: falco

    - name: Remove Falco package (Debian/Ubuntu)
      ansible.builtin.apt:
        name: falco
        state: absent
        purge: true
      when: ansible_os_family == 'Debian'
      ignore_errors: true
      tags: falco

    - name: Remove Falco package (RHEL/CentOS)
      ansible.builtin.yum:
        name: falco
        state: absent
      when: ansible_os_family == 'RedHat'
      ignore_errors: true
      tags: falco

    # =========================================================================
    # Remove native Alloy installation
    # =========================================================================
    - name: Stop Alloy service
      ansible.builtin.service:
        name: alloy
        state: stopped
        enabled: false
      ignore_errors: true
      tags: alloy

    - name: Remove Alloy systemd service file
      ansible.builtin.file:
        path: /etc/systemd/system/alloy.service
        state: absent
      notify: Reload systemd
      tags: alloy

    - name: Remove Alloy binary and directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /opt/alloy
        - /var/lib/alloy
        - /usr/local/bin/alloy
      tags: alloy

    # =========================================================================
    # Cleanup configuration
    # =========================================================================
    - name: Remove Falco configuration directory
      ansible.builtin.file:
        path: /etc/falco
        state: absent
      tags: cleanup

    - name: Remove Alloy configuration directory
      ansible.builtin.file:
        path: /etc/alloy
        state: absent
      tags: cleanup

    - name: Remove VM collectors configuration directory
      ansible.builtin.file:
        path: /etc/sib-collector
        state: absent
      tags: cleanup

    - name: Remove VM collectors data directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/sib-vmagent
      tags: cleanup

    - name: Remove SIB directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/sib
        - /var/log/sib
      tags: cleanup

    - name: Remove SIB Docker network
      community.docker.docker_network:
        name: "{{ docker_network }}"
        state: absent
      when: docker_available | bool
      ignore_errors: true
      tags: cleanup

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

  post_tasks:
    - name: Removal complete
      ansible.builtin.debug:
        msg: |
          ✅ SIB agents removed from {{ inventory_hostname }}
          
          Note: Docker itself was NOT removed.
          Run 'docker system prune' on the host to clean up images.
